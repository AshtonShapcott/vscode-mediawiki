$schema: https://raw.githubusercontent.com/martinring/tmlanguage/master/tmlanguage.json
name: MediaWiki
scopeName: source.mediawiki
fileTypes:
  - mediawiki
  - wiki

patterns:
  - include: "#variable"
  - include: "#comment"
  - include: "#entity"
  - include: "#emphasis"
  - include: "#tag"
  - include: "#table"
  - include: "#heading"
  - include: "#link"
  - include: "#list"
  - include: "#template"

repository:
  variable:
    patterns:
      -
        name: storage.type.variable
        begin: "{{{"
        end: "}}}"
        patterns:
          -
            match: \s*(\w+)\s*(\|)?
            captures:
              1: { name: variable.other }
              2: { name: keyword.operator }

  entity:
    patterns:
      - name: constant.character.entity
        match: '&\w+;'

  list:
    patterns:
      - name: markup.list
        begin: ^([#*;:]+)
        end: $
        beginCaptures:
          1: { name: markup.bold }
        patterns:
          - include: $self

  template:
    patterns:
      - name: meta.template
        begin: ({{)\s*([\w ]+)\s*
        end: "}}"
        beginCaptures:
          1: { name: storage.type.function }
          2: { name: entity.name.function }
        endCaptures:
          0: { name: storage.type.function }
        patterns:
          -
            name: meta.template.attribute
            begin: (\|)\s*(\w+)=
            end: "(?=}}|[|])"
            beginCaptures:
              1: { name: punctuation.definition.tag.begin }
              2: { name: variable.parameter.function }
            patterns:
              - include: "$self"
          -
            name: meta.template.value
            match: (\|)(.*?)(?=}}|[|\n])
            captures:
              1: { name: punctuation.definition.tag.begin }

  link:
    patterns:
      - name: meta.tag.link.internal
        begin: (\[\[)\s*(.+?)[ ]*(\|)
        end: \]\]
        beginCaptures:
          1: { name: punctuation.definition.tag.begin }
          2: { name: markup.underline.link }
          3: { name: punctuation.definition.tag }
        endCaptures:
          0: { name: punctuation.definition.tag.end }
        contentName: string.unquoted
        patterns:
          - include: "$self"



      - name: meta.tag.link.external
        match: (\[)(.*?)[\s]+(.*?)(\])
        captures:
          1: { name: punctuation.definition.tag.begin }
          2:
            patterns:
              - include: "#url"
          3: { name: string.unquoted }
          4: { name: punctuation.definition.tag.end }

  comment:
    name: comment.block.html
    begin: "<!--"
    end: "-->"
    captures:
      0: { name: punctuation.definition.comment.html }
    patterns:
      - match: "\\G-?>"
        name: invalid.illegal.characters-not-allowed-here.html
      - match: "<!--(?!>)|<!-(?=-->)"
        name: invalid.illegal.characters-not-allowed-here.html
      - match: "--!>"
        name: invalid.illegal.characters-not-allowed-here.html

  emphasis:
    patterns:
      -
        match: (''''')((.*?))(''''')
        captures:
          1: { name: punctuation.definition.tag.begin }
          2: { name: markup.bold }
          3: { name: markup.italic }
          4: { name: punctuation.definition.tag.end }
      -
        match: "(''')(.*?)(''')"
        captures:
          1: { name: punctuation.definition.tag.begin }
          2: { name: markup.bold }
          3: { name: punctuation.definition.tag.end }
      - 
        match: "('')(.*?)('')"
        captures:
          1: { name: punctuation.definition.tag.begin }
          2: { name: markup.italic }
          3: { name: punctuation.definition.tag.end }

  heading:
    patterns:
      - name: meta.tag.block.heading
        match: (===?=?=?=?)(.*)(\1)
        captures:
          1: { name: punctuation.definition.tag.begin }
          2: { name: markup.bold }
          3: { name: punctuation.definition.tag.end }

  tag:
    patterns:
      - include: "#nowiki"
      - include: "#html"
      - include: "#preformatted"
      - include: "#inserted"
      - include: "#deleted"

      - name: meta.tag.begin
        match: (<)(\w+)(.*?)(/?>)
        captures:
          1: { name: punctuation.definition.tag.begin }
          2: { name: entity.name.tag.block.any }
          3:
            patterns:
              - include: "#attribute"
          4: { name: punctuation.definition.tag.end }

      - name: meta.tag.end
        match: (</)(\w+)(>)
        captures:
          1: { name: punctuation.definition.tag.begin }
          2: { name: entity.name.tag.block.any }
          3: { name: punctuation.definition.tag.end }

    repository:
      html:
        patterns:
          - name: meta.tag.block.html
            begin: (?i)(<)(html)(>)
            end: (?i)(</)(html)(>)
            beginCaptures:
              1: { name: punctuation.definition.tag.begin }
              2: { name: entity.name.tag }
              3: { name: punctuation.definition.tag.end }
            endCaptures:
              1: { name: punctuation.definition.tag.begin }
              2: { name: entity.name.tag }
              3: { name: punctuation.definition.tag.end }
            patterns:
              - include: text.html.basic

      nowiki:
        patterns:
          - name: meta.tag.block.nowiki
            begin: (?i)(<)(nowiki)(\s.*?)(>)
            end: (?i)(</)(nowiki)(>)
            beginCaptures:
              1: { name: punctuation.definition.tag.begin }
              2: { name: entity.name.tag }
              3:
                patterns:
                  - include: "#attribute"
              4: { name: punctuation.definition.tag.end }
            endCaptures:
              1: { name: punctuation.definition.tag.begin }
              2: { name: entity.name.tag }
              3: { name: punctuation.definition.tag.end }

      inserted:
        patterns:
          -
            name: meta.tag.block.inserted
            begin: (<)(ins|u)(\s.*?)(>)
            end: (</)(\2)(>)
            beginCaptures:
              1: { name: punctuation.definition.tag.begin }
              2: { name: entity.name.tag }
              3:
                patterns:
                  - include: "#attribute"
              4: { name: punctuation.definition.tag.end }
            endCaptures:
              1: { name: punctuation.definition.tag.begin }
              2: { name: entity.name.tag }
              3: { name: punctuation.definition.tag.end }
            contentName: markup.underline
      
      deleted:
        patterns:
          -
            name: meta.tag.block.deleted
            begin: (?i)(<)(del|s)(\s.*?)?(>)
            end: (?i)(</)(\2)(>)
            beginCaptures:
              1: { name: punctuation.definition.tag.begin }
              2: { name: entity.name.tag }
              3:
                patterns:
                  - include: "#attribute"
              4: { name: punctuation.definition.tag.end }
            endCaptures:
              1: { name: punctuation.definition.tag.begin }
              2: { name: entity.name.tag }
              3: { name: punctuation.definition.tag.end }
            contentName: markup.deleted

      preformatted:
        patterns:
          -
            name: meta.tag.block.preformatted
            begin: (<)(pre)(\s.*?)(>)
            end: (</)(\2)(>)
            beginCaptures:
              1: { name: punctuation.definition.tag.begin }
              2: { name: entity.name.tag }
              3:
                patterns:
                  - include: "#attribute"
              4: { name: punctuation.definition.tag.end }
            endCaptures:
              1: { name: punctuation.definition.tag.begin }
              2: { name: entity.name.tag }
              3: { name: punctuation.definition.tag.end }



  table:
    patterns:
      - name: meta.tag.block.table
        begin: "^\\s*({\\|)(.*?)$"
        end: "^\\s*\\|}"
        beginCaptures:
          1: { name: punctuation.definition.tag.begin }
          2:
            patterns:
              - include: "#attribute"
          3: { name: invalid.illegal }
        endCaptures:
          0: { name: punctuation.definition.tag.end }
        patterns:
          - include: "#template"
          - include: "#caption"
          - include: "#row"
          - include: "#heading"
          - include: "#data"
    repository:
      caption:
        name: meta.tag.block.table-caption
        begin: "^\\s*(\\|\\+)"
        end: "$"
        beginCaptures:
          1: { name: punctuation.definition.tag.begin }

      row:
        name: meta.tag.block.table-row
        match: "^\\s*(\\|\\-)[\\s]*(.*)"
        captures:
          1: { name: punctuation.definition.tag.begin }
          2: { name: invalid.illegal }
      
      heading:
        name: meta.tag.block.table.heading
        begin: ^\s*(!)((.*?)(\|))?(.*?)(?=(!!)|$)
        end: $
        beginCaptures:
          1: { name: punctuation.definition.tag.begin }
          3:
            patterns:
              - include: "#attribute"
          4: { name: punctuation.definition.tag }
          5: { name: markup.bold }
        patterns:
          -
            name: meta.tag.block.table.heading.inline
            match: (!!)((.*?)(\|))?(.*?)(?=(!!)|$)
            captures:
              1: { name: punctuation.definition.tag.begin }
              3:
                patterns:
                  - include: "#attribute"
              4: { name: punctuation.definition.tag }
              5: { name: markup.bold }
          - include: $self
      
      data:
        name: meta.tag.block.table.data
        begin: ^\s*(\|)((.*?)(\|^[\|]))?
        end: "$"
        beginCaptures:
          1: { name: punctuation.definition.tag.begin }
          3:
            patterns:
              - include: "#attribute"
          4: { name: punctuation.definition.tag }
        patterns:
          - name: meta.tag.block.table.data.inline
            begin: (\|\|)((.*?)(\|^[\|]))?
            end: $
            beginCaptures:
              1: { name: punctuation.definition.tag.begin }
              3:
                patterns:
                  - include: "#attribute"
              4: { name: punctuation.definition.tag }
          - include: $self

  attribute:
    patterns:
      - match: (\w+)\s*(?:=\s*(.*?)(?:\s+|$))?
        captures:
          1: { name: entity.other.attribute-name }
          2:
            patterns:
              - include: "#string"

  string:
    patterns:
      - name: string.quoted.double
        begin: \"
        end: \"
      - name: string.quoted.single
        begin: \'
        end: \'

  url:
    patterns:
      - name: markup.underline.link
        match: (?:http(s)?:\/\/)?[\w.-]+(?:\.[\w\.-]+)+[\w\-\._~:\/?#\[\]@!\$&'\(\)\*\+,;=.]+
      - name: invalid.illegal.characters-not-allowed-here
        match: .*